{% extends 'layouts/base.html' %}
{% load timetags%}
{% load static %}

{% block title %} {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

<!-- MDBootstrap Datatables  -->
<style xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
    .modal-body{
        height: 80vh;
        overflow-y: auto;
    }
</style>
<link href="{% static 'assets/css/bootstrap-select.css' %}" rel="stylesheet" />


{% endblock stylesheets %}

{% block content %}

<div class="row">
    <div class="col-xl">
        <div class="card">
            <div class="card-header">
                <div class="container bg-neutral text-darker font-weight-bold mw-100 justify-content-end">
                    <p class="text-darker font-weight-bold">
                            {% if src_db_v %}
                            <i class="fa fa-angle-double-up" aria-hidden="true"></i>
                            {{ src_db_v.name }} - {{ src_db_v.username }} @ {{ src_db_v.host }} : {{ src_db_v.port }}
                            (<img src="{% static 'assets/img/' %}{{src_db_v.type}}.png" width="40" height="40" alt="{{dst_db_v.type}}">)
                            {% endif %}
                    </p>
                    <p class="text-darker font-weight-bold">
                            {% if dst_db_v %}
                            <i class="fa fa-angle-double-down" aria-hidden="true"></i>
                            {{ dst_db_v.name }} - {{ dst_db_v.username }} @ {{ dst_db_v.host }} : {{ dst_db_v.port }}
                            (<img src="{% static 'assets/img/' %}{{dst_db_v.type}}.png" width="40" height="40" alt="{{dst_db_v.type}}">)
                            {% endif %}
                    </p>
                </div>
                {% if last_update is not None %}
                <p class="float-right"> <h4><strong>Last Compared: {{ last_update|print_timestamp }}</strong></h4></p>
                {% endif %}
                <div class="card-header-pills">
                    <p>
                        <button class="btn btn-secondary" type="button" data-toggle="collapse"
                                data-target="#collapseResults" aria-expanded="false" aria-controls="collapseResults">
                            <b>Job Status </b> <i class="fa fa-sort-down"></i>
                        </button>
                    </p>
                    <div class="collapse" id="collapseResults">
                        <button id="bt-refresh-res" value= "{{ compare_dbs }}" class="btn btn-primary"
                                type="button"><i class="fa fa-recycle" aria-hidden="true"></i></button>
                        <div class="card card-body">
                            <table>
                                <tr>
                                    <th>Jobs</th>
                                    <th>Status</th>
                                </tr>
                                <tr>
                                    <td>Table Rows</td>
                                    <td><i id="compare_db_rows" class='fa fa-times' style="color:red"></i></td>
                                </tr>
                                <tr>
                                    <td>Table Data Types</td>
                                    <td><i id="compare_db_data_types" class='fa fa-times' style="color:red"></i></td>
                                </tr>
                                <tr>
                                    <td>Table FK/UI's</td>
                                    <td><i id="compare_db_tables_fk_ui" class='fa fa-times' style="color:red"></i></td>
                                </tr>
                                <tr>
                                    <td>Views</td>
                                    <td><i id="compare_db_views" class='fa fa-times' style="color:red"></i></td>
                                </tr>
                                <tr>
                                    <td>Indexes</td>
                                    <td><i id="compare_db_ind" class='fa fa-times' style="color:red"></i></td>
                                </tr>
                                <tr>
                                    <td>Sequences</td>
                                    <td><i id="compare_db_seq" class='fa fa-times' style="color:red"></i></td>
                                </tr>
                                <tr>
                                    <td>Triggers</td>
                                    <td><i id="compare_db_trig" class='fa fa-times' style="color:red"></i></td>
                                </tr>
                                <tr>
                                    <td>FK's</td>
                                    <td><i id="compare_db_fk" class='fa fa-times' style="color:red"></i></td>
                                </tr>
                                <tr>
                                    <td>Procedure</td>
                                    <td><i id="compare_db_proc" class='fa fa-times' style="color:red"></i></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card-header-tabs">
                    <form action="{% url 'dbs:compare_db_results' id1 id2 %}" method="post">
                        <div class="justify-content-start">
                            <p class="float-left">
                            <button class="btn btn-warning btn-outline-danger" type="submit" name="compare" value="compare">Compare Again!</button>
                            </p>
                            {% csrf_token %}
                            <input class="form-check-input" type="text" name="src_db"
                                   value="{{ id1 }}" hidden>
                            <input class="form-check-input" type="text" name="dst_db"
                                   value="{{ id2 }}" hidden>
                            <p class="float-right">
                                <a href="" data-target="#bulkImportModal" data-toggle="modal">
                                    <button class="btn btn-success" type="button" name="bulkImport" value="bulkImport">Bulk Import
                                    </button></a>
                            </p>
                        </div>
                        <div class="justify-content-end">
                            <p class="float-right">
                                <button class="btn btn-success" type="submit" name="enableTrigger" value="enableTrigger">Enable All
                                Trigger
                                </button>
                                <button class="btn btn-warning" type="submit" name="disableTrigger" value="disableTrigger">Disable
                                    All Trigger
                                </button>
                            </p>
                        </div>
                    </form>
                </div>
            </div>

            <nav class="nav nav-pills nav-tabs nav-fill flex-lg-row">
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#table_rows" role="tab"
                       aria-controls="table_rows"
                       aria-selected="true">DB Rows</a>
                    <a class="nav-item nav-link" id="nav-view-tab" data-toggle="tab" href="#table_view" role="tab"
                       aria-controls="table_view"
                       aria-selected="false">Views</a>
                    <a class="nav-item nav-link" id="nav-view-ind" data-toggle="tab" href="#table_ind" role="tab"
                       aria-controls="table_ind"
                       aria-selected="false">Indexes</a>
                    <a class="nav-item nav-link" id="nav-seq-tab" data-toggle="tab" href="#table_seq" role="tab"
                       aria-controls="nav-contact"
                    aria-selected="false">Sequence</a>
                    <a class="nav-item nav-link" id="nav-trig-tab" data-toggle="tab" href="#table_trig" role="tab"
                       aria-controls="table_trig"
                       aria-selected="false">Trigger</a>
                    <a class="nav-item nav-link" id="nav-fk-tab" data-toggle="tab" href="#table_fk" role="tab"
                       aria-controls="table_fk"
                    aria-selected="false">Foreign Key</a>
                    <a class="nav-item nav-link" id="nav-proc-tab" data-toggle="tab" href="#table_proc" role="tab"
                       aria-controls="table_proc"
                       aria-selected="false">Procedure/Function</a>
                </div>
            </nav>
            <div class="card-body">
                <div class="tab-content" id="nav-tabContent">
                    <div class="table-responsive tab-pane fade show active" id="table_rows" role="tabpanel" aria-labelledby="table_rows">
                        <table class="table"
                               data-toolbar="#toolbar"
                               data-toggle="table"
                               data-search="true"
                               data-click-to-select="true"
                               data-show-refresh="true"
                               data-detail-view="true"
                               data-show-footer="true"
                               data-show-columns="false"
                               data-detail-formatter="detailFormatter"
                               data-pagination="true"
                               data-page-list="[25, 50, 100, all]"
                               data-page-size="25"
                               data-url="{% url 'api:dbtablecompare-list' %}?src_db={{id1}}&dst_db={{id2}}&format=json"
                               data-response-handler="responseHandler">
                            <caption>Table Comparison</caption>
                            <thead>
                                <tr>
                                    <th data-field="table_name" data-sortable="true" data-footer-formatter="idFormatter"
                                        data-formatter="extraInfoFormatterTable" scope="col">Table Name</th>
                                    <th data-formatter="extraInfoFormatter" scope="col">Feedback</th>
                                    <th data-field="src_row_count" data-sortable="true"
                                        data-footer-formatter="footerSrcCountFormatter" scope="col">Src # <img
                                            src="{% static 'assets/img/' %}{{src_db_v.type}}.png" width="40" height="40"
                                                         alt="{{src_db_v.type}}"></th>
                                    <th data-field="dst_row_count" data-sortable="true"
                                        data-footer-formatter="footerDstCountFormatter" scope="col">Dst # <img
                                            src="{% static 'assets/img/' %}{{dst_db_v.type}}.png" width="40" height="40"
                                                         alt="{{dst_db_v.type}}"></th>
                                    <th data-field="table_name" data-formatter="operationFormatter" scope="col">Action</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="table-responsive tab-pane fade" id="table_view" role="tabpanel" aria-labelledby="table_view">
                        <table class="table"
                               data-toolbar="#toolbar"
                               data-toggle="table"
                               data-search="true"
                               data-click-to-select="true"
                               data-show-refresh="true"
                               data-detail-view="true"
                               data-show-footer="true"
                               data-show-columns="false"
                               data-detail-formatter="detailFormatter"
                               data-pagination="true"
                               data-page-list="[25, 50, 100, all]"
                               data-page-size="25"
                               data-url="{% url 'api:dbView-list' %}?src_db={{id1}}&dst_db={{id2}}&format=json"
                               data-response-handler="responseHandler">
                            <caption>View comparison</caption>
                            <thead>
                                <tr>
                                    <th data-field="table_name" data-sortable="true" data-footer-formatter="idFormatter"
                                        scope="col">View Name</th>
                                    <th data-field="src_exists" data-sortable="true" data-formatter="booleanFormatter"
                                        data-footer-formatter="footerSrcFormatter" scope="col">Src <img
                                            src="{% static 'assets/img/' %}{{src_db_v.type}}.png" width="40" height="40"
                                                           alt="{{src_db_v.type}}"></th>
                                    <th data-field="dst_exists" data-sortable="true" data-formatter="booleanFormatter"
                                        data-footer-formatter="footerDstFormatter" scope="col">Dst <img
                                            src="{% static 'assets/img/' %}{{dst_db_v.type}}.png" width="40" height="40"
                                                           alt="{{dst_db_v.type}}"></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="table-responsive tab-pane fade" id="table_ind" role="tabpanel" aria-labelledby="table_ind">
                        <table class="table"
                               data-toolbar="#toolbar"
                               data-toggle="table"
                               data-search="true"
                               data-click-to-select="true"
                               data-show-refresh="true"
                               data-detail-view="true"
                               data-show-footer="true"
                               data-show-columns="false"
                               data-detail-formatter="detailFormatter"
                               data-pagination="true"
                               data-page-list="[25, 50, 100, all]"
                               data-page-size="25"
                               data-url="{% url 'api:dbInd-list' %}?src_db={{id1}}&dst_db={{id2}}&format=json"
                               data-response-handler="responseHandler">
                            <caption>Index comparison</caption>
                            <thead>
                            <tr>
                                <th data-field="table_name" data-sortable="true" data-footer-formatter="idFormatter"
                                    scope="col">Index Name</th>
                                <th data-field="src_exists" data-sortable="true" data-formatter="booleanFormatter"
                                    data-footer-formatter="footerSrcFormatter" scope="col">Src <img
                                        src="{% static 'assets/img/' %}{{src_db_v.type}}.png" width="40" height="40"
                                        alt="{{src_db_v.type}}"></th>
                                <th data-field="dst_exists" data-sortable="true" data-formatter="booleanFormatter"
                                    data-footer-formatter="footerDstFormatter" scope="col">Dst <img
                                        src="{% static 'assets/img/' %}{{dst_db_v.type}}.png" width="40" height="40"
                                        alt="{{dst_db_v.type}}"></th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="table-responsive tab-pane fade" id="table_seq" role="tabpanel" aria-labelledby="table_seq">
                        <table class="table"
                               data-toolbar="#toolbar"
                               data-toggle="table"
                               data-search="true"
                               data-click-to-select="true"
                               data-show-refresh="true"
                               data-detail-view="true"
                               data-show-footer="true"
                               data-show-columns="false"
                               data-detail-formatter="detailFormatter"
                               data-pagination="true"
                               data-page-list="[25, 50, 100, all]"
                               data-page-size="25"
                               data-url="{% url 'api:dbSeq-list' %}?src_db={{id1}}&dst_db={{id2}}&format=json"
                               data-response-handler="responseHandler">
                            <caption>Sequence comparison</caption>
                            <thead>
                                <tr>
                                    <th data-field="table_name" data-sortable="true" data-footer-formatter="idFormatter" scope="col">Sequence Name</th>
                                    <th data-field="src_exists" data-sortable="true" data-formatter="booleanFormatter"
                                        data-footer-formatter="footerSrcFormatter" scope="col">Src <img
                                            src="{% static 'assets/img/' %}{{src_db_v.type}}.png" width="40" height="40"
                                                         alt="{{src_db_v.type}}"></th>
                                    <th data-field="dst_exists" data-sortable="true" data-formatter="booleanFormatter"
                                        data-footer-formatter="footerDstFormatter" scope="col">Dst <img
                                            src="{% static 'assets/img/' %}{{dst_db_v.type}}.png" width="40" height="40"
                                                         alt="{{dst_db_v.type}}"></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="table-responsive tab-pane fade" id="table_trig" role="tabpanel" aria-labelledby="table_trig">
                        <table class="table"
                               data-toolbar="#toolbar"
                               data-toggle="table"
                               data-search="true"
                               data-click-to-select="true"
                               data-show-refresh="true"
                               data-detail-view="true"
                               data-show-footer="true"
                               data-show-columns="false"
                               data-detail-formatter="detailFormatter"
                               data-pagination="true"
                               data-page-list="[25, 50, 100, all]"
                               data-page-size="25"
                               data-url="{% url 'api:dbTrig-list' %}?src_db={{id1}}&dst_db={{id2}}&format=json"
                               data-response-handler="responseHandler">
                            <caption>Trigger comparison</caption>
                            <thead>
                            <tr>
                                <th data-field="table_name" data-sortable="true" data-footer-formatter="idFormatter" scope="col">Trigger Name</th>
                                <th data-field="src_exists" data-sortable="true" data-formatter="booleanFormatter"
                                    data-footer-formatter="footerSrcFormatter" scope="col">Src <img
                                        src="{% static 'assets/img/' %}{{src_db_v.type}}.png" width="40" height="40"
                                        alt="{{src_db_v.type}}"></th>
                                <th data-field="dst_exists" data-sortable="true" data-formatter="booleanFormatter"
                                    data-footer-formatter="footerDstFormatter" scope="col">Dst <img
                                        src="{% static 'assets/img/' %}{{dst_db_v.type}}.png" width="40" height="40"
                                        alt="{{dst_db_v.type}}"></th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="table-responsive tab-pane fade accordion" id="table_fk" role="tabpanel" aria-labelledby="table_fk">
                        <table class="table"
                               data-toolbar="#toolbar"
                               data-toggle="table"
                               data-search="true"
                               data-click-to-select="true"
                               data-show-refresh="true"
                               data-detail-view="true"
                               data-show-footer="true"
                               data-show-columns="false"
                               data-detail-formatter="detailFKFormatter"
                               data-pagination="true"
                               data-page-list="[25, 50, 100, all]"
                               data-page-size="25"
                               data-url="{% url 'api:dbobjectfkcompare-list' %}?src_db={{id1}}&dst_db={{id2}}&format=json"
                               data-response-handler="responseHandler">
                            <caption>FK comparison</caption>
                            <thead>
                                <tr>
                                    <th data-field="const_name" data-sortable="true" data-footer-formatter="idFormatter" scope="col">Constraint
                                        Name</th>
                                    <th data-field="src_exists" data-sortable="true" data-formatter="booleanFormatter"
                                        data-footer-formatter="footerSrcFormatter" scope="col">Src <img
                                            src="{% static 'assets/img/' %}{{src_db_v.type}}.png"
                                            width="40" height="40" alt="{{src_db_v.type}}"></th>
                                    <th data-field="dst_exists" data-sortable="true" data-formatter="booleanFormatter"
                                        data-footer-formatter="footerDstFormatter" scope="col">Dst <img
                                            src="{% static 'assets/img/' %}{{dst_db_v.type}}.png"
                                            width="40" height="40" alt="{{dst_db_v.type}}"></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="table-responsive tab-pane fade accordion" id="table_proc" role="tabpanel" aria-labelledby="table_proc">
                        <table class="table"
                               data-toolbar="#toolbar"
                               data-toggle="table"
                               data-search="true"
                               data-click-to-select="true"
                               data-show-refresh="true"
                               data-detail-view="true"
                               data-show-footer="true"
                               data-show-columns="false"
                               data-detail-formatter="detailFormatter"
                               data-pagination="true"
                               data-page-list="[25, 50, 100, all]"
                               data-page-size="25"
                               data-url="{% url 'api:dbProc-list' %}?src_db={{id1}}&dst_db={{id2}}&format=json"
                               data-response-handler="responseHandler">
                            <caption>Procedure comparison</caption>
                            <thead>
                            <tr>
                                <th data-field="table_name" data-sortable="true" data-footer-formatter="idFormatter" scope="col">Procedure/Function
                                    Name</th>
                                <th data-field="src_exists" data-sortable="true" data-formatter="booleanFormatter"
                                    data-footer-formatter="footerSrcFormatter" scope="col">Src <img
                                        src="{% static 'assets/img/' %}{{src_db_v.type}}.png"
                                        width="40" height="40" alt="{{src_db_v.type}}"></th>
                                <th data-field="dst_exists" data-sortable="true" data-formatter="booleanFormatter"
                                    data-footer-formatter="footerDstFormatter" scope="col">Dst <img
                                        src="{% static 'assets/img/' %}{{dst_db_v.type}}.png"
                                        width="40" height="40" alt="{{dst_db_v.type}}"></th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="bulkImportModal">
    <div class="modal-dialog">
        <div class="modal-content bg-neutral text-darker">
            <div class="p-2 mb-2 bg-neutral text-darker">
                <div class="modal-header">
                    <h5 class="modal-title text-info">Bulk Import Tool</h5>
                    <button type="button" class="close" data-dismiss="modal">X</button>
                </div>
                <form action="" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <select class="selectpicker" multiple data-live-search="true" data-width="auto" data-style="btn-success"
                                        name="bulkTables">
                                    {% for res in db_compare_res_bulk %}
                                    {% if res.src_row_count != res.dst_row_count %}
                                    <option value="{{ res.table_name }}({{ res.src_row_count }})">{{ res.table_name }}({{ res.src_row_count }})</option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-info" name="bulkCopy" value="bulkCopy">Proceed</button>
                            <button type="button" class="btn btn-warning" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Model -->
<div class="modal fade" id="dataTypeCompareModal" tabindex="-1"
     role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="p-3 mb-2 bg-neutral text-black-50">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                            aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h3 class="modal-title" id="compareDataTypes">Data <> Type</h3>
                </div>
                <div class="modal-body">
                    -------
                    <p>
                        <i class="tim-icons icon-atom" aria-label="loading"></i>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model -->
<div class="modal fade" id="dataCompareModal" tabindex="-1"
     role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="p-3 mb-2 bg-neutral text-black-50">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                            aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h3 class="modal-title" id="CompareTableData">Compare Table Data</h3>
                </div>
                    <div class="modal-body">
                        -------
                        <p>
                            <i class="tim-icons icon-atom" aria-label="loading"></i>
                        </p>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
<script type="text/javascript">
    $('select').selectpicker();

    $('body').on('click', '[data-toggle="modal"]', function(){
        $($(this).data("target")+' .modal-body').load($(this).data("remote"));
    });
</script>
<script type="text/javascript">
    $(document).on('click', '#compareData', function(e){
        e.preventDefault();
        var $crf_token = $('[name="csrfmiddlewaretoken"]').attr('value');
        var bt_val = $(this).val().split('::');
        var selected_cols = [];
        $('input[name="compare_list"]:checked').each(function () {
            selected_cols.push(this.value);
        });
        $.ajax({
                   type: "GET",
                   headers:{"X-CSRFToken": $crf_token},
                   xhrFields: {
                       withCredentials: true
                   },
                   url: "/api/v1/dbTableAction/compareRawData?table_name=" + bt_val[0]
                        + "&src_id="+ bt_val[1] + "&dst_id="+ bt_val[2] + "&compare_list=" + selected_cols,
                   data: {
                       unparsed_value: null
                   },
                   xhr: function() {
                       var xhr = new XMLHttpRequest();
                       xhr.onreadystatechange = function() {
                           if (xhr.readyState === 2) {
                               if (xhr.status === 200) {
                                   xhr.responseType = "blob";
                               } else {
                                   xhr.responseType = "text";
                               }
                           }
                       };
                       return xhr;
                   },
                   success: function (result, status, xhr) {
                       //Convert the Byte Data to BLOB object.
                       var blob = new Blob([result], { type: "application/octetstream" });
                       var filename = "";
                       var disposition = xhr.getResponseHeader('Content-Disposition');
                       if (disposition && disposition.indexOf('attachment') !== -1) {
                           var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                           var matches = filenameRegex.exec(disposition);
                           if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
                       }
                       //Check the Browser type and download the File.
                       var isIE = false || !!document.documentMode;
                       if (isIE) {
                           window.navigator.msSaveBlob(blob, fileName);
                       } else {
                           var url = window.URL || window.webkitURL;
                           link = url.createObjectURL(blob);
                           var a = $("<a />");
                           a.attr("download", filename);
                           a.attr("href", link);
                           $("body").append(a);
                           a[0].click();
                           $("body").remove(a);
                       }
                   },
                   error: function (xhr, textStatus, errorThrown) {
                       if (xhr.status !== 200) {
                           alert($.parseJSON(xhr.responseText).SuccessMessage);
                       }
                   }
               });
    });
    $(document).on('click', '#btn-copy', function(e){
        e.preventDefault();
        var $crf_token = $('[name="csrfmiddlewaretoken"]').attr('value');
        var bt_val = $(this).val().split('::');
        $.ajax({
           type: "PUT",
           headers:{"X-CSRFToken": $crf_token},
           dataType: "json",
           xhrFields: {
               withCredentials: true
           },
           url: "/api/v1/dbTableAction/copy?table_name=" + bt_val[0]
                + "&row_count="+ bt_val[1] + "&src_id="+ bt_val[2] + "&dst_id="+ bt_val[3] ,
           data: {
               unparsed_value: $(this).val()
           },
           beforeSend:function(){
               return confirm("Are you sure you want to copy data?");
           },
           success: function (data) {
               alert(data.SuccessMessage);
           },
           error: function (data) {
               alert(data.SuccessMessage);
           }
       });
    });
    $(document).on('click', '#btn-trun', function(e){
        e.preventDefault();
        var $crf_token = $('[name="csrfmiddlewaretoken"]').attr('value');
        var bt_val = $(this).val().split('::');
        $.ajax({
           type: "PUT",
           headers:{"X-CSRFToken": $crf_token},
           dataType: "json",
           xhrFields: {
               withCredentials: true
           },
           url: "/api/v1/dbTableAction/truncate?table_name=" + bt_val[0]
                + "&dst_id="+ bt_val[1] ,
           data: {
               unparsed_value: $(this).val()
           },
           beforeSend:function(){
               return confirm("Are you sure you want to truncate?");
           },
           success: function (data) {
               alert(data.SuccessMessage);
           },
           error: function (data) {
               alert(data.SuccessMessage);
           }
       });
    });
</script>
<script>
    var $table = $('#table')

    function responseHandler(res) {
        var flatArray = [];
        $.each(res.results, function(i, element) {
            flatArray.push(element);
        });
        load(flatArray)
        return flatArray;
    }

    function load(flatArray){
        $('#table').bootstrapTable("load", flatArray);
    }

    function detailFormatter(index, row) {
        var html = []
        $.each(row, function (key, value) {
            if(typeof value === "string" || typeof value === "boolean" || value === parseInt(value, 10)) {
                html.push('<p><b>' + key + ':</b> ' + value + '</p>')
            }
        })
        return html.join('')
    }

    function extraInfoFormatter(value, row, index) {
        var html = []
        if(typeof(value) != undefined) {
            var url_mask =
                "{% url 'dbs:compare_data_types' id1=999999999 id2=666666666 table_name='DUMMY' %}"
                    .replace('999999999', row.compare_dbs.src_db.id)
                    .replace('666666666', row.compare_dbs.dst_db.id)
                    .replace('DUMMY', value);

            var isGeom = row.geom;
            var hasModule = row.module_id;
            var isMismatchCol = row.mismatch_in_cols_count;
            var isMismatchRow = parseInt(row.src_row_count, 10) !== parseInt(row.dst_row_count, 10);
            html.push('<p align="center">')
            if (isGeom) {
                html.push('<i class="fa fa-map-marker" aria-hidden="true" title="Geom"></i>')
            }
            if (hasModule) {
                html.push('<i class="fa fa-adjust" aria-hidden="true" title="Module ID"></i>')
            }
            if (isMismatchRow) {
                html.push('<i class="fa fa-times" style="color: red;" title="Row count mis-match"></i>')
            }
            if (isMismatchCol) {
                html.push('<i class="fa fa-pen-square" aria-hidden="true" title="Mismatch in Cols"></i>')
            }
            if(!isGeom && !isMismatchRow && !isMismatchCol){
                html.push('-')
            }
            html.push('</p>')
        }
        return html.join('')
    }

    function extraInfoFormatterTable(value, row, index) {
        var html = []
        if(typeof(value) != undefined) {
            // var url_mask =
            //     "{% url 'dbs:compare_data_types' id1=999999999 id2=666666666 table_name='DUMMY' %}"
            //         .replace('999999999', row.compare_dbs.src_db.id)
            //         .replace('666666666', row.compare_dbs.dst_db.id)
            //         .replace('DUMMY', value);
            //
            //
            // html.push('<a " '
            //           + '  data-toggle="modal" data-remote="' + url_mask
            //           + '" data-target="#dataTypeCompareModal"><button class="btn btn-secondary" type="button">' +
            //           value +
            //           '</button></a>')
            //
            // html.push('</p>')
            html.push('<b>');
            html.push(value);
            html.push('</b>');
        }
        return html.join('')
    }

    function operationFormatter(value, row, index) {
        var url_mask =
            "{% url 'dbs:compare_data' id1=999999999 id2=666666666 table_name='DUMMY' %}"
                .replace('999999999', row.compare_dbs.src_db.id)
                .replace('666666666', row.compare_dbs.dst_db.id)
                .replace('DUMMY', value);
        return [
            '<p align="center">',
            '<a data-toggle="modal" data-remote="' + url_mask + '" data-target="#dataCompareModal">' +
            '<button id="btn-compare-real-d" type="button" value="' + ''
            + row.table_name + '::' + row.compare_dbs.src_db.id + '::' + row.compare_dbs.dst_db.id +
            '" class="btn btn-icon btn-warning" title="Compare data">',
            '<i class="fas fa-drafting-compass" aria-hidden="true"></i>',
            '</button></a>',
            // '<button id="btn-compare-fk-ui" type="button" value="' + ''
            // + row.table_name + '::' + row.compare_dbs.src_db.id + '::' + row.compare_dbs.dst_db.id +
            // '" class="btn btn-icon btn-warning" title="Compare PK/UI">',
            // '<i class="fas fa-anchor" aria-hidden="true"></i>',
            // '</button>',
            '<button id="btn-copy" type="button" value="' + ''
            + row.table_name + '::' + row.src_row_count + '::' + row.compare_dbs.src_db.id + '::' + row.compare_dbs.dst_db.id +
            '" class="btn btn-icon btn-info" title="Copy to PG">',
            '<i class="fa fa-copy" aria-hidden="true"></i>',
            '</button>',
            '<button id="btn-trun" type="button" value="' + ''
            + row.table_name + '::' + row.compare_dbs.dst_db.id +
            '" class="btn btn-icon btn-danger" title="Truncate PG table">' +
            '<i class="fa fa-trash" aria-hidden="true"></i>',
            '</button>',
            '</p>',
        ].join('')
    }

    function idFormatter(row) {
        var count = 0
        $.each(row, function (key, value1) {
            if (value1) {
                count++
            }
        })
        return '<b><p style="color:red;font-size:18px;">Total : ' + count + '</p></b>'
    }

    function footerSrcFormatter(row) {
        var count = 0
        $.each(row, function (key, value1) {
            if (value1.src_exists === true) {
                count++
            }
        })
        return '<b><p style="color:red;font-size:18px;">' + count + '</p></b>'
    }

    function footerSrcCountFormatter(row) {
        var count = 0
        $.each(row, function (key, value1) {
            if (value1 && (value1.src_row_count !== 0 && value1.src_row_count !== null)) {
                count++
            }
        })
        return '<b><p style="color:red;font-size:18px;">' + count + '</p></b>'
    }

    function footerDstFormatter(row) {
        var count = 0
        $.each(row, function (key, value1) {
            if (value1.dst_exists === true) {
                count++
            }
        })
        return '<b><p style="color:red;font-size:18px;">' + count + '</p></b>'
    }

    function footerDstCountFormatter(row) {
        var count = 0
        $.each(row, function (key, value1) {
            if (value1 && (value1.dst_row_count !== 0 && value1.dst_row_count !== null)) {
                count++
            }
        })
        return '<b><p style="color:red;font-size:18px;">' + count + '</p></b>'
    }

    function detailFKFormatter(index, row) {
        var html = []
        if (row.src_1_table_name !== null) {
            html.push('<p><b>' + row.src_1_table_name + '(' + row.src_1_col_name
                      + ') <i class="fa fa-arrow-circle-right"></i> ' + row.src_2_table_name + '(' + row.src_2_col_name +
                      ') </b></p>')
        }
        if (row.dst_1_table_name !== null) {
            html.push('<p><b>' + row.dst_1_table_name + '(' + row.dst_1_col_name
                      + ') <i class="fa fa-arrow-circle-right"></i> ' + row.dst_2_table_name + '(' + row.dst_2_col_name +
                      ') </b></p>')
        }
        return html.join('')
    }

    function booleanFormatter(value, row) {
        if (value === true) {
            return "<i class='fa fa-check' style=\"color:green\"></i>"
        } else {
            return "<i class='fa fa-times' style=\"color:red\"></i>"
        }
    }
</script>
<script type="text/javascript">
    function make_status_call(bt_val) {
        var all_list = ['#compare_db_rows', '#compare_db_data_types', '#compare_db_tables_fk_ui',
                        '#compare_db_views', '#compare_db_ind', '#compare_db_seq',
                        '#compare_db_trig', '#compare_db_fk', '#compare_db_proc'];
        function reload_change_icon(id_name) {
            document.querySelector(id_name).classList.remove('fa-times');
            document.querySelector(id_name).classList.add('fa-spinner');
            document.querySelector(id_name).classList.add('fa-spin');
            document.querySelector(id_name).style = null;
        }

        for(let v=0; v<all_list.length;v++) {
            reload_change_icon(all_list[v]);
        }

        var loc = window.location;
        var wsStart = 'ws://';
        if (loc.protocol == 'https:') {
            wsStart = 'wss://'
        }
        for(let v=0; v<all_list.length;v++) {
            const socket = new WebSocket(wsStart + window.location.host + '/ws/ticks/');
            const args = {"compare_ids": bt_val, "func_name":  all_list[v].replace('#', '')}
            socket.onopen = function open() {
                console.log('WebSockets connection created.');
                this.send(JSON.stringify(args));
            };
            socket.onmessage = function (event) {
                if(event.data === "success") {
                    document.querySelector(all_list[v]).classList.remove('fa-spinner');
                    document.querySelector(all_list[v]).classList.remove('fa-spin');
                    document.querySelector(all_list[v]).classList.remove('fa-minus-square');
                    document.querySelector(all_list[v]).classList.remove('fa-question-circle');
                    document.querySelector(all_list[v]).classList.add('fa-check');
                    document.querySelector(all_list[v]).style = 'color: green;';
                }
                if(event.data === "failure") {
                    document.querySelector(all_list[v]).classList.remove('fa-spinner');
                    document.querySelector(all_list[v]).classList.remove('fa-spin');
                    document.querySelector(all_list[v]).classList.remove('fa-minus-square');
                    document.querySelector(all_list[v]).classList.remove('fa-question-circle');
                    document.querySelector(all_list[v]).classList.add('fa-times');
                    document.querySelector(all_list[v]).style = 'color: red;';
                }
            };
            socket.onerror = function(err) {
                console.error('Socket encountered error: ', err.message, 'Closing socket');
                document.querySelector(all_list[v]).classList.remove('fa-spinner');
                document.querySelector(all_list[v]).classList.remove('fa-spin');
                document.querySelector(all_list[v]).classList.add('fa-question-circle');
                document.querySelector(all_list[v]).style = 'color: orange;';
            };
            socket.onclose = function () {
                console.log('WebSockets connection closed.');
                socket.close();
            };
        }
    }
    $(document).on('click', '#bt-refresh-res', function(e) {
        e.preventDefault();
        var bt_val = $(this).val();
        make_status_call(bt_val);
    });
    window.onload = function() {
        var bt_val = document.getElementById("bt-refresh-res").value;
        make_status_call(bt_val);
    };
</script>
{% endblock javascripts %}
